<!DOCTYPE html>
<html>
    <head>
    <title>URL COVID QR</title>
    
    <link rel="stylesheet" type="text/css" href="index.css" />
    <script src="jquery-3.5.1.min.js"> </script>

    <script src="html5-qrcode.min.js"></script>


    <script src="library.js"> </script>

<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<!-- Optional theme -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>    

<script type="text/javascript">

function enviarAsistencia(){
  var c = document.getElementById("Carnet").value;
  var ub = document.getElementById("qr-reader-results").innerText.split('|');
  console.log(c);
  console.log(ub);
  var ubId= ub[0].split(' ');
  var id = ubId[ubId.length - 1];
  console.log(id);
  if (String(c).length > 0){
    if (isNaN(id)){
      alert('codigo QR no valido');

    }else{
      var r = confirm("Est√° seguro de enviar esta asistencia?");
        if (r == true) {

          console.log('enviando asistencia');
          var data = {
            "carnet" : c,
            "ubicacion" : id
          };
          console.log(data);
          
          $.post( url + "grabaAsistencia", data, function(response){ 
            if ("{'msg':'OK'}" === response){
              alert("La informacion ha sido enviada. " );
            }else
              alert ("hubo un error al enviar el mensaje, por favor intente despues");
              //console.log(response);
          });
        }
      
    }
  }else{
    alert('ingrese un carnet valido');
  }
    
 }

      async function getCarnet(){
        var res;
        res = await fetch(url + "/getCarnet?carnet=" + carnet);
        var resp = await res.json();
        console.log(resp);
      }

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-24451557-1']);
      _gaq.push(['_trackPageview']);
    
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    
    </script>
     
    </head>
    
      <body>
     
        <nav class="navbar navbar-inverse" style="font-size: xx-large;">
            <div class="container-fluid">
              <div class="navbar-header">
                <a class="navbar-brand" href="#">QR URL</a>
              </div>
              <ul class="nav navbar-nav">
                <li class="active"><a href="index.html">Inicio</a></li>
                <li><a href="reportar.html">Reportarse Positivo</a></li>
              </ul>
            </div>
          </nav>
          

    <div id="main" style="font-size: xx-large;">
      <!--<label for="fname">Ingrese su Carnet</label> <br> -->

      <h3>Ingrese su Carnet</h3>
      <input type="text" id="Carnet" name="Carnet" ><br><br>

      <div class="center">
        <div id="qr-reader" style="width:500px"></div>
        <div id="qr-reader-results"></div>
      </div>
     </div> 




 
    <button class="btn btn-primary btn-lg navbar-btn" onclick="enviarAsistencia();" >Enviar Ubicacion</button>
    <button class="btn btn-danger btn-lg navbar-btn" onclick="location.reload();">Reiniciar Pagina</button>
    </body>
    </html>


<script>
var resultContainer = document.getElementById('qr-reader-results');
var lastResult, countResults = 0;

function onScanSuccess(qrCodeMessage) {
    if (qrCodeMessage !== lastResult) {
        ++countResults;
        lastResult = qrCodeMessage;
        resultContainer.innerHTML 
            += `<div>[${countResults}] - ${qrCodeMessage}</div>`;
    }
}

var html5QrcodeScanner = new Html5QrcodeScanner(
    "qr-reader", { fps: 10, qrbox: 250 });
html5QrcodeScanner.render(onScanSuccess);

</script>